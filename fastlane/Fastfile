# Fastfile for Comfy Portal
# Documentation: https://docs.fastlane.tools

default_platform(:ios)

# App Store Connect API Key configuration
def api_key
  # Check for JSON file first (CI environment)
  json_key_path = File.expand_path("~/.appstoreconnect/api_key.json")
  if File.exist?(json_key_path)
    app_store_connect_api_key(
      key_id: "82FT2H36TV",
      issuer_id: "9a16e452-2d62-45dd-b87e-9043389a7e3d",
      key_content: JSON.parse(File.read(json_key_path))["key"],
      duration: 1200,
      in_house: false
    )
  else
    # Fallback to .p8 file (local development)
    app_store_connect_api_key(
      key_id: "82FT2H36TV",
      issuer_id: "9a16e452-2d62-45dd-b87e-9043389a7e3d",
      key_filepath: File.expand_path("~/.appstoreconnect/private_keys/AuthKey_82FT2H36TV.p8"),
      duration: 1200,
      in_house: false
    )
  end
end

platform :ios do

  # Setup CI environment (keychain, etc.) automatically
  before_all do
    if is_ci
      setup_ci
    end
  end

  desc "Sync certificates and provisioning profiles using Match"
  lane :sync_certificates do
    match(
      type: "appstore",
      api_key: api_key,
      readonly: is_ci
    )
  end

  desc "Increment build number based on latest TestFlight build"
  lane :bump do
    latest = latest_testflight_build_number(
      api_key: api_key,
      app_identifier: "com.sillyl12324.comfy-portal"
    )
    new_build_number = latest + 1
    increment_build_number(
      xcodeproj: "ios/ComfyPortal.xcodeproj",
      build_number: new_build_number
    )
    UI.success("Build number incremented to #{new_build_number} (was #{latest} on TestFlight)")
  end

  desc "Build the app"
  lane :build do
    sync_certificates

    # Configure manual code signing
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/ComfyPortal.xcodeproj",
      team_id: "QUVB58SSQ7",
      bundle_identifier: "com.sillyl12324.comfy-portal",
      profile_name: "match AppStore com.sillyl12324.comfy-portal",
      code_sign_identity: "iPhone Distribution"
    )

    build_app(
      workspace: "ios/ComfyPortal.xcworkspace",
      scheme: "ComfyPortal",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "ComfyPortal.ipa"
    )
  end

  desc "Upload to TestFlight (internal testing)"
  lane :beta do
    bump
    build

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      distribute_external: false
    )

    UI.success("Successfully uploaded to TestFlight!")
  end

  desc "Upload to TestFlight and notify external testers"
  lane :beta_external do
    bump
    build

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: false,
      distribute_external: true,
      groups: ["External Testers"],
      changelog: "Bug fixes and improvements"
    )

    UI.success("Successfully distributed to external testers!")
  end

  desc "Submit to App Store for review"
  lane :release do
    bump
    build

    upload_to_app_store(
      api_key: api_key,
      skip_metadata: false,
      skip_screenshots: true,
      submit_for_review: true,
      automatic_release: true,
      force: true,
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )

    UI.success("Successfully submitted to App Store for review!")
  end

  desc "Upload to App Store without submitting for review"
  lane :upload_only do
    bump
    build

    upload_to_app_store(
      api_key: api_key,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false
    )

    UI.success("Successfully uploaded to App Store Connect!")
  end

  # ============================================
  # Error Handling
  # ============================================

  error do |lane, exception|
    UI.error("Error in lane #{lane}: #{exception.message}")
  end

end

# ============================================
# Android Platform
# ============================================

platform :android do

  before_all do
    if is_ci
      setup_ci
    end
  end

  desc "Increment versionCode based on latest Google Play internal track"
  lane :bump do
    # Read current versionCode from build.gradle
    build_gradle = File.read("../android/app/build.gradle")
    current_version_code = build_gradle.match(/versionCode\s+(\d+)/)[1].to_i

    # Try to get latest version code from Google Play
    begin
      version_codes = google_play_track_version_codes(
        track: "internal",
        package_name: "com.sillyl12324.comfyportal"
      )
      latest = version_codes.max || 0
    rescue => e
      UI.important("Could not fetch version codes from Google Play: #{e.message}")
      latest = current_version_code
    end

    new_version_code = [latest, current_version_code].max + 1

    # Update versionCode in build.gradle
    updated_gradle = build_gradle.gsub(/versionCode\s+\d+/, "versionCode #{new_version_code}")
    File.write("../android/app/build.gradle", updated_gradle)

    UI.success("versionCode incremented to #{new_version_code} (was #{current_version_code} local, #{latest} on Google Play)")
  end

  desc "Build Android AAB using Gradle"
  lane :build do
    # Generate native project (android/ is gitignored, must prebuild in CI)
    sh("cd .. && npx expo prebuild --platform android")

    # Ensure gradlew is executable
    sh("chmod +x ../android/gradlew")

    # Build AAB using shell command (avoids Fastlane gradle() path issues)
    sh("cd ../android && ./gradlew bundleRelease")

    # Copy AAB to build directory
    sh("mkdir -p ../build")
    sh("cp ../android/app/build/outputs/bundle/release/app-release.aab ../build/ComfyPortal.aab")
    UI.success("Android AAB built at build/ComfyPortal.aab")
  end

  desc "Upload to Google Play internal testing track"
  lane :beta do
    upload_to_play_store(
      track: "internal",
      aab: "./build/ComfyPortal.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: "completed"
    )

    UI.success("Successfully uploaded to Google Play internal testing!")
  end

  desc "Upload to Google Play production"
  lane :release do
    upload_to_play_store(
      track: "production",
      aab: "./build/ComfyPortal.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: "completed"
    )

    UI.success("Successfully uploaded to Google Play production!")
  end

  desc "Promote internal testing to production"
  lane :promote do
    upload_to_play_store(
      track: "internal",
      track_promote_to: "production",
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("Successfully promoted to production!")
  end

  desc "Build and upload to internal testing"
  lane :deploy do
    bump
    build
    beta
  end

  # ============================================
  # Error Handling
  # ============================================

  error do |lane, exception|
    UI.error("Error in lane #{lane}: #{exception.message}")
  end

end
