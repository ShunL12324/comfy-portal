@using ComfyPortal.Models
@using System.Text.Json

<MudCard Elevation="1" Class="node-card">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Memory" Size="Size.Small" Class="mr-1" />
                Load Diffusion Model (UNET)
            </MudText>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent>
        <MudSelect @bind-Value="_selectedUnet"
                   Label="UNET Model"
                   Variant="Variant.Outlined"
                   Margin="Margin.Dense"
                   Required>
            @foreach (var unet in _availableUnets)
            {
                <MudSelectItem Value="@unet">@unet</MudSelectItem>
            }
        </MudSelect>

        <MudSelect @bind-Value="_weightDtype"
                   Label="Weight Data Type"
                   Variant="Variant.Outlined"
                   Margin="Margin.Dense"
                   Class="mt-2">
            <MudSelectItem Value="@("default")">Default</MudSelectItem>
            <MudSelectItem Value="@("fp8_e4m3fn")">FP8 E4M3FN</MudSelectItem>
            <MudSelectItem Value="@("fp8_e5m2")">FP8 E5M2</MudSelectItem>
            <MudSelectItem Value="@("fp16")">FP16</MudSelectItem>
            <MudSelectItem Value="@("fp32")">FP32</MudSelectItem>
        </MudSelect>

        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
            Loads UNET/diffusion model separately from CLIP
        </MudAlert>
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public required WorkflowNode Node { get; set; }

    [Parameter]
    public EventCallback<WorkflowNode> OnNodeChanged { get; set; }

    [Inject]
    private IServerService ServerService { get; set; } = default!;

    private List<string> _availableUnets = new();
    private string _selectedUnet = "";
    private string _weightDtype = "default";

    protected override async Task OnInitializedAsync()
    {
        // Load values from node inputs
        if (Node.Inputs.TryGetValue("unet_name", out var unetVal) && unetVal.ValueKind == JsonValueKind.String)
        {
            var unetStr = unetVal.GetString();
            if (unetStr != null)
                _selectedUnet = unetStr;
        }

        if (Node.Inputs.TryGetValue("weight_dtype", out var dtypeVal) && dtypeVal.ValueKind == JsonValueKind.String)
        {
            var dtypeStr = dtypeVal.GetString();
            if (dtypeStr != null)
                _weightDtype = dtypeStr;
        }

        // Load available UNETs from server
        try
        {
            var servers = await ServerService.GetAllServersAsync();
            if (servers.Any())
            {
                var models = await ServerService.GetServerModelsAsync(servers.First().Id);
                _availableUnets = models.Unets;

                if (!_availableUnets.Contains(_selectedUnet) && _availableUnets.Any())
                    _selectedUnet = _availableUnets.First();
            }
        }
        catch
        {
            // Fallback to empty list if server fetch fails
            _availableUnets = new List<string> { "flux1-dev.safetensors" };
        }
    }
}
