@using ComfyPortal.Models
@using ComfyPortal.Services.Server
@using System.Text.Json

<MudCard Elevation="1" Class="node-card">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Source" Size="Size.Small" Class="mr-1" />
                Checkpoint Loader
            </MudText>
            @if (Node.Meta?.Title != null)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">@Node.Meta.Title</MudText>
            }
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent>
        <MudSelect @bind-Value="_selectedCheckpoint"
                   Label="Checkpoint Model"
                   Variant="Variant.Outlined"
                   Margin="Margin.Dense"
                   HelperText="Select the base model to use">
            @if (_checkpoints.Any())
            {
                @foreach (var checkpoint in _checkpoints)
                {
                    <MudSelectItem Value="@checkpoint.Name">@checkpoint.Name</MudSelectItem>
                }
            }
            else
            {
                <MudSelectItem Value="" Disabled>No checkpoints available - sync server models</MudSelectItem>
            }
        </MudSelect>

        @if (!_checkpoints.Any())
        {
            <MudAlert Severity="Severity.Info" Dense Class="mt-2">
                Connect to a server and sync models to see available checkpoints
            </MudAlert>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public required WorkflowNode Node { get; set; }

    [Parameter]
    public EventCallback<WorkflowNode> OnNodeChanged { get; set; }

    [Inject]
    private IServerService ServerService { get; set; } = default!;

    private List<ComfyUIModel> _checkpoints = new();
    private string _selectedCheckpoint = "";

    protected override async Task OnInitializedAsync()
    {
        // Load available checkpoints from servers
        var servers = await ServerService.GetAllServersAsync();
        foreach (var server in servers)
        {
            var models = await ServerService.GetServerModelsAsync(server.Id, "checkpoints");
            _checkpoints.AddRange(models);
        }

        // Set current value from node inputs
        if (Node.Inputs.TryGetValue("ckpt_name", out var value) &&
            value.ValueKind == JsonValueKind.String)
        {
            _selectedCheckpoint = value.GetString() ?? "";
        }
    }

    private async Task OnCheckpointChanged(string value)
    {
        _selectedCheckpoint = value;

        // Update node inputs
        Node.Inputs["ckpt_name"] = JsonDocument.Parse($"\"{value}\"").RootElement;

        await OnNodeChanged.InvokeAsync(Node);
    }
}
