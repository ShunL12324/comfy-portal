@using ComfyPortal.Models
@using System.Text.Json

<MudCard Elevation="1" Class="node-card">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Save" Size="Size.Small" Class="mr-1" />
                @(Node.ClassType == "PreviewImage" ? "Preview Image" : "Save Image")
            </MudText>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent>
        <MudTextField @bind-Value="_filenamePrefix"
                     Label="Filename Prefix"
                     Variant="Variant.Outlined"
                     Margin="Margin.Dense"
                     HelperText="Prefix for saved images" />

        @if (_hasImageInput)
        {
            <MudText Typo="Typo.body2" Color="Color.Success" Class="mt-2">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                Connected to image source
            </MudText>
        }
        else
        {
            <MudText Typo="Typo.body2" Color="Color.Warning" Class="mt-2">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" />
                No image source connected
            </MudText>
        }

        @if (Node.ClassType == "SaveImage")
        {
            <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                Images will be saved to ComfyUI output folder
            </MudAlert>
        }
        else if (Node.ClassType == "PreviewImage")
        {
            <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                Images will be displayed in preview
            </MudAlert>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public required WorkflowNode Node { get; set; }

    [Parameter]
    public EventCallback<WorkflowNode> OnNodeChanged { get; set; }

    private string _filenamePrefix = "ComfyUI";
    private bool _hasImageInput;

    protected override void OnInitialized()
    {
        // Load values from node inputs
        if (Node.Inputs.TryGetValue("filename_prefix", out var prefixVal) && prefixVal.ValueKind == JsonValueKind.String)
        {
            var prefixStr = prefixVal.GetString();
            if (prefixStr != null)
                _filenamePrefix = prefixStr;
        }

        // Check if images input is connected (array format means connection)
        if (Node.Inputs.TryGetValue("images", out var imagesVal) && imagesVal.ValueKind == JsonValueKind.Array)
            _hasImageInput = true;
    }
}
